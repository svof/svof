<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE MudletPackage>
<MudletPackage version="1.001">
	<TriggerPackage>
		<Trigger isActive="yes" isFolder="no" isTempTrigger="no" isMultiline="no" isPerlSlashGOption="no" isColorizerTrigger="no" isFilterTrigger="no" isSoundTrigger="no" isColorTrigger="no" isColorTriggerFg="no" isColorTriggerBg="no">
			<name>Stuff has boiled</name>
			<script>svo.rf_magichappened()</script>
			<triggerType>0</triggerType>
			<conditonLineDelta>0</conditonLineDelta>
			<mStayOpen>0</mStayOpen>
			<mCommand></mCommand>
			<packageName></packageName>
			<mFgColor>#ff0000</mFgColor>
			<mBgColor>#ffff00</mBgColor>
			<mSoundFile></mSoundFile>
			<colorTriggerFgColor>#000000</colorTriggerFgColor>
			<colorTriggerBgColor>#000000</colorTriggerBgColor>
			<regexCodeList>
				<string>With a sudden slow pulsing of white light, the liquid and floating bits of plant</string>
				<string>The liquid in .+ pot boils away, leaving nothing but an unpleasant odour and some scattered bits of plant matter.</string>
			</regexCodeList>
			<regexCodePropertyList>
				<integer>2</integer>
				<integer>1</integer>
			</regexCodePropertyList>
		</Trigger>
		<Trigger isActive="no" isFolder="no" isTempTrigger="no" isMultiline="no" isPerlSlashGOption="no" isColorizerTrigger="no" isFilterTrigger="no" isSoundTrigger="no" isColorTrigger="no" isColorTriggerFg="no" isColorTriggerBg="no">
			<name>Arty vial</name>
			<script>svo.rf_fillarty()</script>
			<triggerType>0</triggerType>
			<conditonLineDelta>0</conditonLineDelta>
			<mStayOpen>0</mStayOpen>
			<mCommand></mCommand>
			<packageName></packageName>
			<mFgColor>#ff0000</mFgColor>
			<mBgColor>#ffff00</mBgColor>
			<mSoundFile></mSoundFile>
			<colorTriggerFgColor>#000000</colorTriggerFgColor>
			<colorTriggerBgColor>#000000</colorTriggerBgColor>
			<regexCodeList>
				<string>That would be more fills than are in this pot.</string>
			</regexCodeList>
			<regexCodePropertyList>
				<integer>3</integer>
			</regexCodePropertyList>
		</Trigger>
		<Trigger isActive="no" isFolder="no" isTempTrigger="no" isMultiline="no" isPerlSlashGOption="no" isColorizerTrigger="no" isFilterTrigger="no" isSoundTrigger="no" isColorTrigger="no" isColorTriggerFg="no" isColorTriggerBg="no">
			<name>Filled a vial</name>
			<script>svo.rf_fillnext()</script>
			<triggerType>0</triggerType>
			<conditonLineDelta>0</conditonLineDelta>
			<mStayOpen>0</mStayOpen>
			<mCommand></mCommand>
			<packageName></packageName>
			<mFgColor>#ff0000</mFgColor>
			<mBgColor>#ffff00</mBgColor>
			<mSoundFile></mSoundFile>
			<colorTriggerFgColor>#000000</colorTriggerFgColor>
			<colorTriggerBgColor>#000000</colorTriggerBgColor>
			<regexCodeList>
				<string>You slowly pour the liquid from</string>
			</regexCodeList>
			<regexCodePropertyList>
				<integer>2</integer>
			</regexCodePropertyList>
		</Trigger>
		<Trigger isActive="yes" isFolder="no" isTempTrigger="no" isMultiline="no" isPerlSlashGOption="no" isColorizerTrigger="no" isFilterTrigger="no" isSoundTrigger="no" isColorTrigger="no" isColorTriggerFg="no" isColorTriggerBg="no">
			<name>Stop refilling</name>
			<script>svo.rf_nextpotion()</script>
			<triggerType>0</triggerType>
			<conditonLineDelta>0</conditonLineDelta>
			<mStayOpen>0</mStayOpen>
			<mCommand></mCommand>
			<packageName></packageName>
			<mFgColor>#ff0000</mFgColor>
			<mBgColor>#ffff00</mBgColor>
			<mSoundFile></mSoundFile>
			<colorTriggerFgColor>#000000</colorTriggerFgColor>
			<colorTriggerBgColor>#000000</colorTriggerBgColor>
			<regexCodeList>
				<string>You do not possess an empty.</string>
				<string>^You cannot .+ pot with that\.$</string>
			</regexCodeList>
			<regexCodePropertyList>
				<integer>3</integer>
				<integer>1</integer>
			</regexCodePropertyList>
		</Trigger>
		<Trigger isActive="yes" isFolder="no" isTempTrigger="no" isMultiline="no" isPerlSlashGOption="no" isColorizerTrigger="no" isFilterTrigger="no" isSoundTrigger="no" isColorTrigger="no" isColorTriggerFg="no" isColorTriggerBg="no">
			<name>Missing ingredients</name>
			<script>svo.rf_missingstuff()</script>
			<triggerType>0</triggerType>
			<conditonLineDelta>0</conditonLineDelta>
			<mStayOpen>0</mStayOpen>
			<mCommand></mCommand>
			<packageName></packageName>
			<mFgColor>#ff0000</mFgColor>
			<mBgColor>#ffff00</mBgColor>
			<mSoundFile></mSoundFile>
			<colorTriggerFgColor>#000000</colorTriggerFgColor>
			<colorTriggerBgColor>#000000</colorTriggerBgColor>
			<regexCodeList>
				<string>You must specify a valid concoctions component to inpot.</string>
			</regexCodeList>
			<regexCodePropertyList>
				<integer>3</integer>
			</regexCodePropertyList>
		</Trigger>
		<Trigger isActive="yes" isFolder="no" isTempTrigger="no" isMultiline="no" isPerlSlashGOption="no" isColorizerTrigger="no" isFilterTrigger="no" isSoundTrigger="no" isColorTrigger="no" isColorTriggerFg="no" isColorTriggerBg="no">
			<name>Look for artefact vials</name>
			<script>svo.rf_arties = {}</script>
			<triggerType>0</triggerType>
			<conditonLineDelta>0</conditonLineDelta>
			<mStayOpen>300</mStayOpen>
			<mCommand></mCommand>
			<packageName></packageName>
			<mFgColor>#ff0000</mFgColor>
			<mBgColor>#ffff00</mBgColor>
			<mSoundFile></mSoundFile>
			<colorTriggerFgColor>#000000</colorTriggerFgColor>
			<colorTriggerBgColor>#000000</colorTriggerBgColor>
			<regexCodeList>
				<string>You are holding:</string>
			</regexCodeList>
			<regexCodePropertyList>
				<integer>3</integer>
			</regexCodePropertyList>
			<Trigger isActive="yes" isFolder="no" isTempTrigger="no" isMultiline="no" isPerlSlashGOption="no" isColorizerTrigger="no" isFilterTrigger="no" isSoundTrigger="no" isColorTrigger="no" isColorTriggerFg="no" isColorTriggerBg="no">
				<name>An artefact vial</name>
				<script>svo.rf_arties[#svo.rf_arties+1] = tonumber(matches[2])</script>
				<triggerType>0</triggerType>
				<conditonLineDelta>0</conditonLineDelta>
				<mStayOpen>0</mStayOpen>
				<mCommand></mCommand>
				<packageName></packageName>
				<mFgColor>#ff0000</mFgColor>
				<mBgColor>#ffff00</mBgColor>
				<mSoundFile></mSoundFile>
				<colorTriggerFgColor>#000000</colorTriggerFgColor>
				<colorTriggerBgColor>#000000</colorTriggerBgColor>
				<regexCodeList>
					<string>^ +vial(\d+)</string>
				</regexCodeList>
				<regexCodePropertyList>
					<integer>1</integer>
				</regexCodePropertyList>
			</Trigger>
			<Trigger isActive="yes" isFolder="no" isTempTrigger="no" isMultiline="no" isPerlSlashGOption="no" isColorizerTrigger="no" isFilterTrigger="no" isSoundTrigger="no" isColorTrigger="no" isColorTriggerFg="no" isColorTriggerBg="no">
				<name>Stop</name>
				<script>setTriggerStayOpen("Look for artefact vials", 0)

if not svo.rf_refilling or not next(svo.rf_refilling.p) then return end

echo'\n' svo.echof("Found %d artefact vials to use in refills (%s).", table.size(svo.rf_arties), svo.concatand(svo.rf_arties)) svo.showprompt()

svo.rf_nextpotion()</script>
				<triggerType>0</triggerType>
				<conditonLineDelta>0</conditonLineDelta>
				<mStayOpen>0</mStayOpen>
				<mCommand></mCommand>
				<packageName></packageName>
				<mFgColor>#ff0000</mFgColor>
				<mBgColor>#ffff00</mBgColor>
				<mSoundFile></mSoundFile>
				<colorTriggerFgColor>#000000</colorTriggerFgColor>
				<colorTriggerBgColor>#000000</colorTriggerBgColor>
				<regexCodeList>
					<string></string>
				</regexCodeList>
				<regexCodePropertyList>
					<integer>7</integer>
				</regexCodePropertyList>
			</Trigger>
		</Trigger>
		<Trigger isActive="yes" isFolder="no" isTempTrigger="no" isMultiline="yes" isPerlSlashGOption="no" isColorizerTrigger="no" isFilterTrigger="no" isSoundTrigger="no" isColorTrigger="no" isColorTriggerFg="no" isColorTriggerBg="no">
			<name>Putting vials away</name>
			<script>if not svo.putvials then return end
svo.doadd("put 50 vial in "..(svo.conf.packid or 'pack'))</script>
			<triggerType>0</triggerType>
			<conditonLineDelta>1</conditonLineDelta>
			<mStayOpen>0</mStayOpen>
			<mCommand></mCommand>
			<packageName></packageName>
			<mFgColor>#ff0000</mFgColor>
			<mBgColor>#ffff00</mBgColor>
			<mSoundFile></mSoundFile>
			<colorTriggerFgColor>#000000</colorTriggerFgColor>
			<colorTriggerBgColor>#000000</colorTriggerBgColor>
			<regexCodeList>
				<string>You put</string>
				<string></string>
			</regexCodeList>
			<regexCodePropertyList>
				<integer>2</integer>
				<integer>7</integer>
			</regexCodePropertyList>
		</Trigger>
		<Trigger isActive="yes" isFolder="no" isTempTrigger="no" isMultiline="no" isPerlSlashGOption="no" isColorizerTrigger="no" isFilterTrigger="no" isSoundTrigger="no" isColorTrigger="no" isColorTriggerFg="no" isColorTriggerBg="no">
			<name>Done with putvials</name>
			<script>if not svo.putvials then return end

svo.putvials = nil
echo'\n' svo.echof("Done stuffing away vials - they can give theirs now.")</script>
			<triggerType>0</triggerType>
			<conditonLineDelta>0</conditonLineDelta>
			<mStayOpen>0</mStayOpen>
			<mCommand></mCommand>
			<packageName></packageName>
			<mFgColor>#ff0000</mFgColor>
			<mBgColor>#ffff00</mBgColor>
			<mSoundFile></mSoundFile>
			<colorTriggerFgColor>#000000</colorTriggerFgColor>
			<colorTriggerBgColor>#000000</colorTriggerBgColor>
			<regexCodeList>
				<string>You hold no more of that item.</string>
			</regexCodeList>
			<regexCodePropertyList>
				<integer>3</integer>
			</regexCodePropertyList>
		</Trigger>
		<Trigger isActive="yes" isFolder="no" isTempTrigger="no" isMultiline="yes" isPerlSlashGOption="no" isColorizerTrigger="no" isFilterTrigger="no" isSoundTrigger="no" isColorTrigger="no" isColorTriggerFg="no" isColorTriggerBg="no">
			<name>Getting vials back</name>
			<script>if not svo.getvials then return end
svo.doadd("get 50 vial from "..(svo.conf.packid or 'pack'))</script>
			<triggerType>0</triggerType>
			<conditonLineDelta>1</conditonLineDelta>
			<mStayOpen>0</mStayOpen>
			<mCommand></mCommand>
			<packageName></packageName>
			<mFgColor>#ff0000</mFgColor>
			<mBgColor>#ffff00</mBgColor>
			<mSoundFile></mSoundFile>
			<colorTriggerFgColor>#000000</colorTriggerFgColor>
			<colorTriggerBgColor>#000000</colorTriggerBgColor>
			<regexCodeList>
				<string>You take</string>
				<string></string>
			</regexCodeList>
			<regexCodePropertyList>
				<integer>2</integer>
				<integer>7</integer>
			</regexCodePropertyList>
		</Trigger>
		<Trigger isActive="yes" isFolder="no" isTempTrigger="no" isMultiline="no" isPerlSlashGOption="no" isColorizerTrigger="no" isFilterTrigger="no" isSoundTrigger="no" isColorTrigger="no" isColorTriggerFg="no" isColorTriggerBg="no">
			<name>Done with getvials</name>
			<script>if not svo.getvials then return end

svo.getvials = nil
echo'\n' svo.echof("Retrieved all of your vials back.")</script>
			<triggerType>0</triggerType>
			<conditonLineDelta>0</conditonLineDelta>
			<mStayOpen>0</mStayOpen>
			<mCommand></mCommand>
			<packageName></packageName>
			<mFgColor>#ff0000</mFgColor>
			<mBgColor>#ffff00</mBgColor>
			<mSoundFile></mSoundFile>
			<colorTriggerFgColor>#000000</colorTriggerFgColor>
			<colorTriggerBgColor>#000000</colorTriggerBgColor>
			<regexCodeList>
				<string>There are no more </string>
				<string>doesn't contain that</string>
			</regexCodeList>
			<regexCodePropertyList>
				<integer>2</integer>
				<integer>0</integer>
			</regexCodePropertyList>
		</Trigger>
		<Trigger isActive="yes" isFolder="no" isTempTrigger="no" isMultiline="yes" isPerlSlashGOption="no" isColorizerTrigger="no" isFilterTrigger="no" isSoundTrigger="no" isColorTrigger="no" isColorTriggerFg="no" isColorTriggerBg="no">
			<name>Giving vials away</name>
			<script>svo.doadd("give 50 vial to "..svo.givevials.person)</script>
			<triggerType>0</triggerType>
			<conditonLineDelta>1</conditonLineDelta>
			<mStayOpen>0</mStayOpen>
			<mCommand></mCommand>
			<packageName></packageName>
			<mFgColor>#ff0000</mFgColor>
			<mBgColor>#ffff00</mBgColor>
			<mSoundFile></mSoundFile>
			<colorTriggerFgColor>#000000</colorTriggerFgColor>
			<colorTriggerBgColor>#000000</colorTriggerBgColor>
			<regexCodeList>
				<string>You give</string>
				<string>return isPrompt() and svo.givevials</string>
			</regexCodeList>
			<regexCodePropertyList>
				<integer>2</integer>
				<integer>4</integer>
			</regexCodePropertyList>
		</Trigger>
		<Trigger isActive="yes" isFolder="no" isTempTrigger="no" isMultiline="no" isPerlSlashGOption="no" isColorizerTrigger="no" isFilterTrigger="no" isSoundTrigger="no" isColorTrigger="no" isColorTriggerFg="no" isColorTriggerBg="no">
			<name>Done with givevials</name>
			<script>if not svo.givevials then return end

if svo.givevials.selfish then
  svo.defs.keepup("selfishness", true)
end

svo.givevials = nil
echo'\n' svo.echof("Handed all vials over.")</script>
			<triggerType>0</triggerType>
			<conditonLineDelta>0</conditonLineDelta>
			<mStayOpen>0</mStayOpen>
			<mCommand></mCommand>
			<packageName></packageName>
			<mFgColor>#ff0000</mFgColor>
			<mBgColor>#ffff00</mBgColor>
			<mSoundFile></mSoundFile>
			<colorTriggerFgColor>#000000</colorTriggerFgColor>
			<colorTriggerBgColor>#000000</colorTriggerBgColor>
			<regexCodeList>
				<string>You hold no more of that item.</string>
			</regexCodeList>
			<regexCodePropertyList>
				<integer>3</integer>
			</regexCodePropertyList>
		</Trigger>
	</TriggerPackage>
	<TimerPackage />
	<AliasPackage>
		<Alias isActive="yes" isFolder="no">
			<name>Refill something</name>
			<script>-- refill 5 health 2 arty, 3 restoration
-- don't kill refilling from tuns
if command:find("refill %w+ with %w+") then send(command, false) return end
if command:find("refill %w+ from %w+") then send(command, false) return end

if matches[2] == 'cancel' then svo.rf_cancel() svo.showprompt() echo'\n' return end

-- sometimes people install things and forget about them... two refillers using same alias causes problems
if wieczoRefiller then svo.echof("Warning: You have another refiller installed as well! Things will double-up and be messy.") return end

svo.rf_refill(matches[2])</script>
			<command></command>
			<packageName></packageName>
			<regex>^refill (.+)$</regex>
		</Alias>
		<Alias isActive="yes" isFolder="no">
			<name>Refill next potion</name>
			<script>-- this alias is only for the refiller to do the next potion once it's done getting
-- herbs out of the pot after a failed fill (when you didn't have enough herbs)
svo.rf_nextpotion()</script>
			<command></command>
			<packageName></packageName>
			<regex>^refill next potion$</regex>
		</Alias>
		<Alias isActive="yes" isFolder="no">
			<name>(putvials) Put vials away</name>
			<script>svo.putvials = true
svo.doadd("put 50 vial in "..(svo.conf.packid or 'pack'))</script>
			<command></command>
			<packageName></packageName>
			<regex>^putvials$</regex>
		</Alias>
		<Alias isActive="yes" isFolder="no">
			<name>(getvials) Retrieve vials</name>
			<script>svo.getvials = true
svo.doadd("get 50 vial from "..(svo.conf.packid or 'pack'))</script>
			<command></command>
			<packageName></packageName>
			<regex>^getvials$</regex>
		</Alias>
		<Alias isActive="yes" isFolder="no">
			<name>(givevials) Hand over vials</name>
			<script>svo.givevials = {person = matches[2]}

if svo.defkeepup[svo.defs.mode].selfishness then
  svo.defs.keepup("selfishness", false)
  svo.givevials.selfish = true
end

svo.doadd("give 50 vial to "..svo.givevials.person)</script>
			<command></command>
			<packageName></packageName>
			<regex>^givevials (\w+)$</regex>
		</Alias>
	</AliasPackage>
	<ActionPackage />
	<ScriptPackage>
		<ScriptGroup isActive="yes" isFolder="yes">
			<name>svo Refiller</name>
			<packageName></packageName>
			<script>function refillerPrio(_, module)
  if module ~= "svo (refiller)" then return end
  setModulePriority(module, 1)
end

registerAnonymousEventHandler("sysInstall", "refillerPrio")

svo.modules_version = svo.modules_version or {}
svo.modules_version["svo (refiller)"] = 1</script>
			<eventHandlerList />
			<Script isActive="yes" isFolder="no">
				<name>refiller code</name>
				<packageName></packageName>
				<script>-- Svof (c) 2011-2018 by Vadim Peretokin

-- Svof is licensed under a
-- Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International License.

-- You should have received a copy of the license along with this
-- work. If not, see &lt;http://creativecommons.org/licenses/by-nc-sa/4.0/&gt;.


tempTimer(0, function()

local conf = svo.conf

svo.rf_debug = false

-- format: {p = {potion = { normal = #, arty = 0/#}}, currentorder = ""}
-- this stores the total order that we need to do
svo.rf_refilling = false

-- format: 'potion'
-- this stores the current potion that we're doing of the whole order

-- need a variable to handle either remedies or toxicology transcendence
svo.rf_currenttrans = svo.rf_currenttrans or false

conf.potid = conf.potid or 'pot'
svo.config.setoption('potid', {
  type = 'string',
  vconfig2string = true,
  onshow = function (defaultcolour)
    fg('gold')
    echoLink("refiller: ", "", "svo Refiller", true)
    fg(defaultcolour) echo("Pot to use is ")
    fg('a_cyan') echoLink((conf.potid or 'pot'), "printCmdLine 'vconfig potid pot###'", "Click to set the pot ID to use for brewing in", true)
    fg(defaultcolour) echo("; storing your vials in")
    fg('a_cyan') echoLink(" "..(conf.packid or 'pack'), "printCmdLine'vconfig packid '", "Click to set the pack ID to stuff your vials into when you do 'putvials'", true)
    fg(defaultcolour) echo(".\n")
  end,
  onset = function ()
    svo.echof("Okay, will brew in the %s item.", conf.potid)
  end
})

conf.packid = conf.packid or 'pack'
svo.config.setoption('packid', {
  type = 'string',
  onset = function ()
    svo.echof("Okay, will store vials in %s when you do 'putvials'. Doing 'getvials' will get them back out.", conf.packid)
  end
})

local concoctions = {
  epidermal = {
    ['kuzu'] = 2,
    ['bloodroot'] = 1,
    ['hawthorn'] = 1,
    ['ginseng'] = 1
  },
  immunity = {
    ['sac'] = 1,
    ['ash'] = 1,
    ['echinacea'] = 2,
  },
  mana = {
    ['slipper'] = 1,
    ['bellwort'] = 1,
    ['hawthorn'] = 1,
    ['bloodroot'] = 1,
  },
  health = {
    ['valerian'] = 1,
    ['goldenseal'] = 1,
    ['ginseng'] = 1,
    ['myrrh'] = 1,
  },
  venom = {
    ['sac'] = 1,
    ['cohosh'] = 1,
    ['kelp'] = 1,
    ['skullcap'] = 1,
  },
  frost = {
    ['kelp'] = 1,
    ['pear'] = 1,
    ['ginseng'] = 1,
  },
  levitation = {
    ['kelp'] = 2,
    ['pear'] = 1,
    ['eaglefeather'] = 1,
  },
  mending = {
    ['ginger'] = 2,
    ['diamonddust'] = 1,
    ['kelp'] = 1,
    ['kuzu'] = 1,
  },
  mass = {
    ['moss'] = 1,
    ['bloodroot'] = 1,
    ['diamonddust'] = 1,
    ['kuzu'] = 1,
  },
  speed = {
    ['skin'] = 2,
    ['goldenseal'] = 1,
    ['kuzu'] = 1,
    ['ginger'] = 1,
  },
  restoration = {
    ['kuzu'] = 2,
    ['valerian'] = 1,
    ['bellwort'] = 1,
    ['gold'] = 2,
  },
  caloric = {
    ['kuzu'] = 2,
    ['kelp'] = 2,
    ['valerian'] = 1,
    ['bellwort'] = 1
  }
}

local toxins = {
  xentio = {
    ['kelp'] = 2,
    ['bloodroot'] = 1,
    ['blueink'] = 1
  },
  oleander = {
    ['bayberry'] = 1,
    ['ginseng'] = 1,
    ['blueink'] = 1
  },
  eurypteria = {
    ['lobelia'] = 1,
    ['goldenseal'] = 1,
    ['redink'] = 1
  },
  kalmia = {
    ['bloodroot'] = 1,
    ['ginseng'] = 1,
    ['moss'] = 1,
    ['redink'] = 1,
    ['blueink'] = 1
  },
  digitalis = {
    ['bellwort'] = 1,
    ['lobelia'] = 1,
    ['redink'] = 1
  },
  darkshade = {
    ['bloodroot'] = 1,
    ['ginseng'] = 1,
    ['kelp'] = 1,
    ['redink'] = 1
  },
  curare = {
    ['bloodroot'] = 1,
    ['bellwort'] = 1,
    ['greenink'] = 1
  },
  epteth = {
    ['valerian'] = 1,
    ['bellwort'] = 1,
    ['yellowink'] = 1
  },
  prefarar = {
    ['bloodroot'] = 1,
    ['ginseng'] = 1,
    ['purpleink'] = 1
  },
  monkshood = {
    ['valerian'] = 1,
    ['bellwort'] = 1,
    ['redink'] = 1
  },
  euphorbia = {
    ['kelp'] = 1,
    ['goldenseal'] = 1,
    ['greenink'] = 1
  },
  colocasia = {
    ['bayberry'] = 1,
    ['hawthorn'] = 1,
    ['blueink'] = 1
  },
  oculus = {
    ['bayberry'] = 1,
    ['goldenseal'] = 1,
    ['redink'] = 1
  },
  vernalius = {
    ['kelp'] = 2,
    ['goldenseal'] = 1,
    ['purpleink'] = 1
  },
  epseth = {
    ['valerian'] = 1,
    ['bellwort'] = 1,
    ['purpleink'] = 1
  },
  larkspur = {
    ['goldenseal'] = 2,
    ['kelp'] = 1,
    ['blueink'] = 1
  },
  slike = {
    ['ginseng'] = 2,
    ['elm'] = 1,
    ['greenink'] = 1
  },
  voyria = {
    ['ginseng'] = 3,
    ['skullcap'] = 2,
    ['goldenseal'] = 2,
    ['goldink'] = 1,
    ['redink'] = 1
  },
  delphinium = {
    ['bellwort'] = 2,
    ['goldenseal'] = 1,
    ['blueink'] = 1
  },
  vardrax = {
    ['skullcap'] = 1,
    ['elm'] = 1,
    ['ginseng'] = 1,
    ['greenink'] = 1
  },
  loki = {
    ['goldenseal'] = 2,
    ['kelp'] = 2,
    ['bloodroot'] = 2,
    ['ginseng'] = 1,
    ['yellowink'] = 2
  },
  aconite = {
    ['goldenseal'] = 2,
    ['lobelia'] = 1,
    ['yellowink'] = 1
  },
  selarnia = {
    ['lobelia'] = 1,
    ['bloodroot'] = 1,
    ['goldink'] = 1
  },
  gecko = {
    ['valerian'] = 1,
    ['bloodroot'] = 1,
    ['kelp'] = 1,
    ['purpleink'] = 1
  }
}

local function outr(what, amount)
  if what == 'gold' then
    svo.sendc("get "..amount.." gold from "..conf.packid, svo.rf_debug)
    return
  end

  if amount == 1 then svo.sendc("outr "..what, svo.rf_debug)
  else svo.sendc("outr "..amount.." "..what, svo.rf_debug) end
end

local function inpot(what, amount, pot)

  while amount &gt; 50 do
    svo.sendc("inpot 50 "..what.." in "..pot, svo.rf_debug)
    amount = amount - 50
  end

  if amount == 1 then
    svo.sendc("inpot "..what.." in "..pot, svo.rf_debug)
  else
    svo.sendc("inpot "..amount.. " "..what.." in "..pot, svo.rf_debug)
  end
end

function svo.rf_fillpot(potion, fills, pot)
  svo.assert(potion and fills, "rf_fillpot: need to supply both what to brew and what amount to brew")

  -- 1 set of ingredients = 1 fill

  -- Have to change this. If I don't, it's going to be a massive
  -- rewrite of the entire refilling system, with lots of duplicate functions
  -- just to accomodate toxins.
  --svo.assert(concoctions[potion], "rf_fillpot: don't know about such a potion")
  if not concoctions[potion] and not toxins[potion] then
    svo.assert(false, "svo.rf_fillpot: don't know about such a potion")
  end

  for item, amount in pairs(concoctions[potion]) do
    outr(item, amount * fills)
    inpot(item, amount * fills, pot or conf.potid)
  end
end

function svo.rf_boilpot(pot)
  pot = pot or conf.potid

  svo.rf_wait_to_boil = tempTimer(getNetworkLatency()+1, function ()
    if not svo.defc.selfishness then
      svo.sendc("boil "..pot.." for "..tostring(svo.rf_refilling.currentorder), svo.rf_debug)
    else
      svo.sendc('generosity', svo.rf_debug)
      svo.rf_temptrigger = tempExactMatchTrigger("You have recovered equilibrium.", "killTrigger(svo.svo.rf_temptrigger); svo.sendc('boil "..pot.." for "..tostring(svo.rf_refilling.currentorder).."', svo.svo.rf_debug)")
    end
  end)
end

function svo.rf_magichappened()
  if not svo.rf_refilling then return end

  svo.doadd(function()
    if svo.rf_refilling.currentorderdata then
      for _ = 1, svo.rf_refilling.currentorderdata.arty do
        svo.rf_fillarty()
      end

      for _ = 1, (svo.rf_refilling.currentorderdata.normal - svo.rf_refilling.currentorderdata.arty) do
        svo.rf_fillnext()
      end
    end

    echo'\n' svo.rf_nextpotion()
  end)
end

function svo.rf_fillnext()
  if not svo.rf_refilling then return end

  svo.sendc("fill emptyvial from "..conf.potid.." "..(svo.rf_currenttrans and 4 or 5).." times", svo.rf_debug)
end

function svo.rf_fillarty()
  if not svo.rf_refilling then return end

  if not svo.rf_arties[1] then
    svo.missing_arty = (svo.missing_arty or 0) + 1
    svo.prompttrigger("warn of missing arties", function()
      svo.echof("You're missing %s artefact vials that were needed in the order, fyi.", svo.missing_arty)
      svo.missing_arty = nil
    end)
    return
  end

  svo.sendc("fill "..table.remove(svo.rf_arties).." from "..conf.potid.." "..(svo.rf_currenttrans and 2 or 3).." times", svo.rf_debug)
end

function svo.rf_cancel()
  svo.rf_refilling = nil
  svo.undoall()
  svo.echof("Cancelled refilling.")
end

function svo.rf_refill(what)
  what = what:split(",")
  local needarties

  svo.rf_refilling = { p = {}, currentorder = false, currentorderdata = false}
  for i = 1, #what do
    what[i] = what[i]:trim()
    local amount, potion
    if what[i]:find("^(%d+) (%w+)") then
      amount, potion = what[i]:match("^(%d+) (%w+)")
    elseif what[i]:find("^(%w+)") then
      amount, potion = 1, what[i]:match("^(%w+)")
    end

    if not concoctions[potion] and not toxins[potion] then
      svo.echof("Don't know the ingredients for a '%s' potion :|", tostring(potion))
    else
      svo.rf_refilling.p[potion] = {normal = tonumber(amount)}
      svo.rf_refilling.p[potion].arty = tonumber(what[i]:match("(%d+) arty$") or 0)

      if svo.rf_refilling.p[potion].arty &gt; 0 then
        needarties = true
      end

      if svo.rf_refilling.p[potion].arty &gt; svo.rf_refilling.p[potion].normal then
        svo.echof("You can't have only %s refills of %s, and %s of them into artefact vials... going to assume you wanted %s %s refills total.", svo.rf_refilling.p[potion].normal, potion, svo.rf_refilling.p[potion].arty, svo.rf_refilling.p[potion].arty, potion)
        svo.rf_refilling.p[potion].normal = svo.rf_refilling.p[potion].arty
      end
    end
  end

  if not next(svo.rf_refilling.p) then
    svo.rf_refilling = nil
    svo.echof("Don't have anything to refill, then :/")
    return
  end

  svo.rf_previousorder = svo.deepcopy(svo.rf_refilling.p)
  if not needarties then svo.rf_nextpotion() else
    svo.echof("Looking for the artefact vials...")
    svo.sendc("config pagelength 250", svo.rf_debug)
    svo.sendc("ii artefact", svo.rf_debug)
    svo.sendc("config pagelength "..(conf.pagelength &gt;= 20 and conf.pagelength or 20), svo.rf_debug)
  end
end

-- to be called only when we need to do the next potion
function svo.rf_nextpotion()
  svo.rf_refilling.currentorder = next(svo.rf_refilling.p)
  svo.rf_refilling.currentorderdata = svo.rf_refilling.p[svo.rf_refilling.currentorder]
  if not svo.rf_refilling.currentorder then
    svo.rf_refilling = nil
    svo.echof("Done refilling!")
    raiseEvent("svo done refilling")
  else
    svo.echof("Going to work on refilling %s.", tostring(svo.rf_refilling.currentorder))

    -- change which trans to check based on what we're brewing
    if concoctions[svo.rf_refilling.currentorder] then
      svo.rf_currenttrans = svo.rf_transrefiller
    else
      svo.rf_currenttrans = svo.rf_transtoxicology
    end

    svo.rf_fillpot(svo.rf_refilling.currentorder,
      -- refill 5 health 2 arty means 3 normal + 2 arty!
      (svo.rf_refilling.p[svo.rf_refilling.currentorder].normal - svo.rf_refilling.p[svo.rf_refilling.currentorder].arty) * (svo.rf_currenttrans and 4 or 5) +
      svo.rf_refilling.p[svo.rf_refilling.currentorder].arty * 2)
    svo.rf_boilpot()

    -- clear the fill so next time rf_nextpotion() is called, it's fine
    svo.rf_refilling.p[svo.rf_refilling.currentorder] = nil
  end
end

function svo.rf_undopot(potion, fills, pot)
  svo.assert(potion and fills, "rf_undopot: need to supply potion and how many fills went in")

  svo.assert(concoctions[potion], "rf_undopot: don't know about such a potion")
  for item, amount in pairs(concoctions[potion]) do
    svo.doadd("get "..amount * fills.." "..item.." from "..(pot or conf.potid))
  end
  svo.doadd("get "..(pot or conf.potid))
  svo.doadd("refill next potion")
end

function svo.rf_missingstuff()
  disableTrigger("Missing ingredients"); tempTimer(2, function() enableTrigger("Missing ingredients") end)
  killTimer(svo.rf_wait_to_boil)

  echo'\n' svo.echof("Ack, looks like you're out of enough ingredients - going to get what we put into the pot back...")

    svo.rf_undopot(svo.rf_refilling.currentorder,
      (svo.rf_refilling.currentorderdata.normal - svo.rf_refilling.currentorderdata.arty) * (svo.rf_currenttrans and 4 or 5) +
      svo.rf_refilling.currentorderdata.arty * 2)
end

end)</script>
				<eventHandlerList />
			</Script>
			<Script isActive="yes" isFolder="no">
				<name>svo.rf_check_trans</name>
				<packageName></packageName>
				<script>function svo.rf_check_trans()
  if not (gmcp and gmcp.Char and gmcp.Char.Skills and gmcp.Char.Skills.Groups) then return end

  svo.rf_transrefiller = false
  svo.rf_transtoxicology = false
  for _, t in pairs(gmcp.Char.Skills.Groups) do
    if t.name and (t.name == "Remedies") and t.rank and t.rank == "Transcendent" then
      svo.rf_transrefiller = true; break
    end
    if t.name and (t.name == "Toxicology") and t.rank and t.rank == "Transcendent" then
      svo.rf_transtoxicology = true;break
    end
  end
end</script>
				<eventHandlerList>
					<string>gmcp.Char.Skills</string>
				</eventHandlerList>
			</Script>
		</ScriptGroup>
	</ScriptPackage>
	<KeyPackage />
	<HelpPackage>
		<helpURL></helpURL>
	</HelpPackage>
</MudletPackage>
