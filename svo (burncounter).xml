<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE MudletPackage>
<MudletPackage version="1.001">
    <TriggerPackage>
        <TriggerGroup isActive="yes" isFolder="yes" isTempTrigger="no" isMultiline="no" isPerlSlashGOption="no" isColorizerTrigger="no" isFilterTrigger="no" isSoundTrigger="no" isColorTrigger="no" isColorTriggerFg="no" isColorTriggerBg="no">
            <name>svo Magi burncounter</name>
            <script></script>
            <triggerType>0</triggerType>
            <conditonLineDelta>0</conditonLineDelta>
            <mStayOpen>0</mStayOpen>
            <mCommand></mCommand>
            <packageName></packageName>
            <mFgColor>#ff0000</mFgColor>
            <mBgColor>#ffff00</mBgColor>
            <mSoundFile></mSoundFile>
            <colorTriggerFgColor>#000000</colorTriggerFgColor>
            <colorTriggerBgColor>#000000</colorTriggerBgColor>
            <regexCodeList/>
            <regexCodePropertyList/>
            <Trigger isActive="yes" isFolder="no" isTempTrigger="no" isMultiline="no" isPerlSlashGOption="no" isColorizerTrigger="no" isFilterTrigger="no" isSoundTrigger="no" isColorTrigger="no" isColorTriggerFg="no" isColorTriggerBg="no">
                <name>Only ablaze</name>
                <script>svo.bl_count(matches[2], &quot;only ablaze&quot;)</script>
                <triggerType>0</triggerType>
                <conditonLineDelta>0</conditonLineDelta>
                <mStayOpen>0</mStayOpen>
                <mCommand></mCommand>
                <packageName></packageName>
                <mFgColor>#ff0000</mFgColor>
                <mBgColor>#ffff00</mBgColor>
                <mSoundFile></mSoundFile>
                <colorTriggerFgColor>#000000</colorTriggerFgColor>
                <colorTriggerBgColor>#000000</colorTriggerBgColor>
                <regexCodeList>
                    <string>^You call upon Kkractle and unleash a forceful blow towards (\w+)'s .+? with your trusty staff\.$</string>
                    <string>^(\w+) bursts into flame as a fiery efreeti spins into (?:him|her)\.$</string>
                </regexCodeList>
                <regexCodePropertyList>
                    <integer>1</integer>
                    <integer>1</integer>
                </regexCodePropertyList>
            </Trigger>
            <Trigger isActive="yes" isFolder="no" isTempTrigger="no" isMultiline="no" isPerlSlashGOption="no" isColorizerTrigger="no" isFilterTrigger="no" isSoundTrigger="no" isColorTrigger="no" isColorTriggerFg="no" isColorTriggerBg="no">
                <name>Add burn level</name>
                <script>svo.bl_count(matches[2], &quot;add level&quot;)</script>
                <triggerType>0</triggerType>
                <conditonLineDelta>0</conditonLineDelta>
                <mStayOpen>0</mStayOpen>
                <mCommand></mCommand>
                <packageName></packageName>
                <mFgColor>#ff0000</mFgColor>
                <mBgColor>#ffff00</mBgColor>
                <mSoundFile></mSoundFile>
                <colorTriggerFgColor>#000000</colorTriggerFgColor>
                <colorTriggerBgColor>#000000</colorTriggerBgColor>
                <regexCodeList>
                    <string>^A dim red glow emanates from the heart of a crystalline golem moments before flames spontaneously ignite upon (\w+)\.$</string>
                </regexCodeList>
                <regexCodePropertyList>
                    <integer>1</integer>
                </regexCodePropertyList>
            </Trigger>
            <Trigger isActive="yes" isFolder="no" isTempTrigger="no" isMultiline="no" isPerlSlashGOption="no" isColorizerTrigger="no" isFilterTrigger="no" isSoundTrigger="no" isColorTrigger="no" isColorTriggerFg="no" isColorTriggerBg="no">
                <name>Add burn level to all</name>
                <script>svo.bl_count(&quot;all&quot;, &quot;add to all&quot;)</script>
                <triggerType>0</triggerType>
                <conditonLineDelta>0</conditonLineDelta>
                <mStayOpen>0</mStayOpen>
                <mCommand></mCommand>
                <packageName></packageName>
                <mFgColor>#ff0000</mFgColor>
                <mBgColor>#ffff00</mBgColor>
                <mSoundFile></mSoundFile>
                <colorTriggerFgColor>#000000</colorTriggerFgColor>
                <colorTriggerBgColor>#000000</colorTriggerBgColor>
                <regexCodeList>
                    <string>The firestorm roars all about you, searing your flesh.</string>
                </regexCodeList>
                <regexCodePropertyList>
                    <integer>3</integer>
                </regexCodePropertyList>
            </Trigger>
            <Trigger isActive="yes" isFolder="no" isTempTrigger="no" isMultiline="no" isPerlSlashGOption="no" isColorizerTrigger="no" isFilterTrigger="no" isSoundTrigger="no" isColorTrigger="no" isColorTriggerFg="no" isColorTriggerBg="no">
                <name>Subtract burn</name>
                <script>svo.bl_count(matches[2], &quot;remove level&quot;)</script>
                <triggerType>0</triggerType>
                <conditonLineDelta>0</conditonLineDelta>
                <mStayOpen>0</mStayOpen>
                <mCommand></mCommand>
                <packageName></packageName>
                <mFgColor>#ff0000</mFgColor>
                <mBgColor>#ffff00</mBgColor>
                <mSoundFile></mSoundFile>
                <colorTriggerFgColor>#000000</colorTriggerFgColor>
                <colorTriggerBgColor>#000000</colorTriggerBgColor>
                <regexCodeList>
                    <string>^The fires consuming (\w+) diminish somewhat\.$</string>
                </regexCodeList>
                <regexCodePropertyList>
                    <integer>1</integer>
                </regexCodePropertyList>
            </Trigger>
            <Trigger isActive="no" isFolder="no" isTempTrigger="no" isMultiline="no" isPerlSlashGOption="no" isColorizerTrigger="no" isFilterTrigger="no" isSoundTrigger="no" isColorTrigger="no" isColorTriggerFg="no" isColorTriggerBg="no">
                <name>svobl Don't register</name>
                <script>-- it's OK, the trigger is supposed to be off by default
svo.bl_ignore()</script>
                <triggerType>0</triggerType>
                <conditonLineDelta>0</conditonLineDelta>
                <mStayOpen>0</mStayOpen>
                <mCommand></mCommand>
                <packageName></packageName>
                <mFgColor>#ff0000</mFgColor>
                <mBgColor>#ffff00</mBgColor>
                <mSoundFile></mSoundFile>
                <colorTriggerFgColor>#000000</colorTriggerFgColor>
                <colorTriggerBgColor>#000000</colorTriggerBgColor>
                <regexCodeList>
                    <string>^\w+ dodges nimbly out of the way\.$</string>
                    <string>^\w+ twists (?:his|her) body out of harm's way\.$</string>
                    <string>^\w+ parries the attack with a deft manoeuvre\.$</string>
                    <string>^\w+ steps into the attack, grabs your arm, and throws you violently to the ground\.$</string>
                    <string>^\w+ quickly jumps back, avoiding the attack\.$</string>
                    <string>^A chaos orb intercepts the attack against \w+ and renders it harmless\.$</string>
                    <string>The attack rebounds back onto you!</string>
                    <string>^A reflection of \w+ blinks out of existence\.$</string>
                    <string>The attack rebounds onto you!</string>
                    <string>^\w+ moves into your attack, knocking your blow aside before viciously countering with a strike to your head\.$</string>
                </regexCodeList>
                <regexCodePropertyList>
                    <integer>1</integer>
                    <integer>1</integer>
                    <integer>1</integer>
                    <integer>1</integer>
                    <integer>1</integer>
                    <integer>1</integer>
                    <integer>3</integer>
                    <integer>1</integer>
                    <integer>3</integer>
                    <integer>1</integer>
                </regexCodePropertyList>
            </Trigger>
            <Trigger isActive="yes" isFolder="no" isTempTrigger="no" isMultiline="no" isPerlSlashGOption="no" isColorizerTrigger="no" isFilterTrigger="no" isSoundTrigger="no" isColorTrigger="no" isColorTriggerFg="no" isColorTriggerBg="no">
                <name>Dehydrate</name>
                <script>svo.bl_count(matches[2], &quot;dehydrate&quot;)</script>
                <triggerType>0</triggerType>
                <conditonLineDelta>0</conditonLineDelta>
                <mStayOpen>0</mStayOpen>
                <mCommand></mCommand>
                <packageName></packageName>
                <mFgColor>#ff0000</mFgColor>
                <mBgColor>#ffff00</mBgColor>
                <mSoundFile></mSoundFile>
                <colorTriggerFgColor>#000000</colorTriggerFgColor>
                <colorTriggerBgColor>#000000</colorTriggerBgColor>
                <regexCodeList>
                    <string>^(\w+) winces in evident discomfort as a crystalline golem points a single appendage at (?:him|her)\.$</string>
                </regexCodeList>
                <regexCodePropertyList>
                    <integer>1</integer>
                </regexCodePropertyList>
            </Trigger>
            <Trigger isActive="yes" isFolder="no" isTempTrigger="no" isMultiline="no" isPerlSlashGOption="no" isColorizerTrigger="no" isFilterTrigger="no" isSoundTrigger="no" isColorTrigger="no" isColorTriggerFg="no" isColorTriggerBg="no">
                <name>Dehydrate expired</name>
                <script>svo.bl_count(matches[2], &quot;lost dehydrate&quot;)</script>
                <triggerType>0</triggerType>
                <conditonLineDelta>0</conditonLineDelta>
                <mStayOpen>0</mStayOpen>
                <mCommand></mCommand>
                <packageName></packageName>
                <mFgColor>#ff0000</mFgColor>
                <mBgColor>#ffff00</mBgColor>
                <mSoundFile></mSoundFile>
                <colorTriggerFgColor>#000000</colorTriggerFgColor>
                <colorTriggerBgColor>#000000</colorTriggerBgColor>
                <regexCodeList>
                    <string>^The skin of (\w+) appears far less dry\.$</string>
                </regexCodeList>
                <regexCodePropertyList>
                    <integer>1</integer>
                </regexCodePropertyList>
            </Trigger>
            <Trigger isActive="yes" isFolder="no" isTempTrigger="no" isMultiline="no" isPerlSlashGOption="no" isColorizerTrigger="no" isFilterTrigger="no" isSoundTrigger="no" isColorTrigger="no" isColorTriggerFg="no" isColorTriggerBg="no">
                <name>Cured ablaze</name>
                <script>svo.bl_count(matches[2], &quot;remove ablaze only&quot;)</script>
                <triggerType>0</triggerType>
                <conditonLineDelta>0</conditonLineDelta>
                <mStayOpen>0</mStayOpen>
                <mCommand></mCommand>
                <packageName></packageName>
                <mFgColor>#ff0000</mFgColor>
                <mBgColor>#ffff00</mBgColor>
                <mSoundFile></mSoundFile>
                <colorTriggerFgColor>#000000</colorTriggerFgColor>
                <colorTriggerBgColor>#000000</colorTriggerBgColor>
                <regexCodeList>
                    <string>^(\w+) takes some salve from a vial and rubs it on (?:his|her) (?:body|torso)\.$</string>
                </regexCodeList>
                <regexCodePropertyList>
                    <integer>1</integer>
                </regexCodePropertyList>
            </Trigger>
        </TriggerGroup>
    </TriggerPackage>
    <TimerPackage/>
    <AliasPackage>
        <AliasGroup isActive="yes" isFolder="yes">
            <name>svo Magi burncounter</name>
            <script></script>
            <command></command>
            <packageName></packageName>
            <regex></regex>
            <Alias isActive="yes" isFolder="no">
                <name>Check status</name>
                <script>if svo.bl_show then svo.bl_show() end</script>
                <command></command>
                <packageName></packageName>
                <regex>^vsl$</regex>
            </Alias>
        </AliasGroup>
    </AliasPackage>
    <ActionPackage/>
    <ScriptPackage>
        <ScriptGroup isActive="yes" isFolder="yes">
            <name>svo Magi burncounter</name>
            <packageName></packageName>
            <script>-- burncounters prompt tag is defined here
-- feel free to tinker with it, but move it out into a script of its own,
-- so your changes don't get erased on an update!
tempTimer(
  0,
  function()
    function svo.bl_prompttag()
      if
        svo.defc.dragonform or not svo.lasthit or not svo.bl_list or not svo.bl_list[svo.lasthit]
      then
        return &quot;&quot;
      end
      local t = svo.bl_list[svo.lasthit]
      return
        string.format(
          &quot;%s%s&quot;, (t.level == 0 and '' or t.level), (t.dehydrate == 0 and '' or &quot; (dehydrated)&quot;)
        )
    end

    svo.adddefinition(&quot;@bl&quot;, &quot;svo.bl_prompttag()&quot;)
  end
)</script>
            <eventHandlerList/>
            <Script isActive="yes" isFolder="no">
                <name>burncounter code</name>
                <packageName></packageName>
                <script>-- Svof (c) 2011-2018 by Vadim Peretokin

-- Svof is licensed under a
-- Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International License.

-- You should have received a copy of the license along with this
-- work. If not, see &lt;http://creativecommons.org/licenses/by-nc-sa/4.0/&gt;.

local sk = svo.sk

local hittable

svo.bl_list = {}
svo.burn_levels = {
  'ablaze',
  'severe',
  'extreme',
  'charred',
  'melting'
}

local bl_list, burn_levels = svo.bl_list, svo.burn_levels

function sk.bl_checkburncounter()
  -- make the announces work with a singleprompt
  local echof = svo.itf
  moveCursor(0, getLineNumber())

  -- we'll only ever have one name here so far. Actually add up the hits here and store them
  local who, action = next(hittable)
  action = action or &quot;&quot;

  if not who then
    echof(&quot;Failed to connect.\n&quot;)
  end

  -- can only add levels if someone is dehydrated
  if action == &quot;add level&quot; and (bl_list[who].dehydrate ~= 0 or bl_list[who].level == 0) then
    bl_list[who].level = bl_list[who].level + 1
    if bl_list[who].level &gt; #burn_levels then bl_list[who].level = #burn_levels end

  elseif action == &quot;only ablaze&quot; and bl_list[who].level == 0 then
    bl_list[who].level = 1
  elseif action == &quot;add to all&quot; then
    for _, data in pairs(bl_list) do
      if data.dehydrate ~= 0 or data.level == 0 then
        data.level = data.level + 1
        if data.level &gt; #burn_levels then data.level = #burn_levels end
      end
    end

    -- wipe the 'all' person, as that is not a real person
    bl_list.all = nil
  elseif action == &quot;remove level&quot; then
    bl_list[who].level = bl_list[who].level - 1
    if bl_list[who].level &lt; 0 then bl_list[who].level = 0 end
  elseif action == 'dehydrate' then
    if bl_list[who].dehydrate ~= 0 then
      killTimer(bl_list[who].dehydrate)
    end

    bl_list[who].dehydrate = tempTimer(45+svo.getping(), function()
      bl_list[who].dehydrate = 0
      echof(&quot;\n%s's dehydrate wore off.\n&quot;, who)
      svo.showprompt()
    end)
  elseif action == &quot;lost dehydrate&quot; then
    if bl_list[who].dehydrate ~= 0 then
      killTimer(bl_list[who].dehydrate)
      bl_list[who].dehydrate = 0
    end

  elseif action == &quot;remove ablaze only&quot; then
    if bl_list[who].level == 1 then
      bl_list[who].level = 0
    end
  else
    svo.debugf(&quot;bl_checkburncounter: unknown action '%s'&quot;, action)
  end

  raiseEvent(&quot;svo burncounter hit&quot;, who)

  -- if a specific person and they are ablaze
  if who ~= 'all' and bl_list[who].level &gt; 0 then
    echof(&quot;%ss burn is %s (%s).%s\n&quot;, who, burn_levels[bl_list[who].level], bl_list[who].level, (bl_list[who].dehydrate == 0 and '' or ' They are also dehydrated.'))
  -- if a specific person and their ablaze was cured
  elseif who ~= 'all' and bl_list[who].level == 0 then
    echof(&quot;%s isn't on fire%s.\n&quot;, who, (bl_list[who].dehydrate == 0 and '' or ' (but they are dehydrated)'))
  else
    local function getburnlevels()
      local t = {}
      for person, data in pairs(bl_list) do
        if data.dehydrate ~= 0 then
          t[#t+1] = string.format(&quot;%s's burn is %s (%s)%s&quot;, person, burn_levels[data.level], data.level, (data.dehydrate == 0 and '' or ' and dehydrated'))
        end
      end

      return svo.concatand(t)
    end

    local burnsstring = getburnlevels()
    if burnsstring ~= &quot;&quot; then
      echof(&quot;%s.\n&quot;, burnsstring)
    end
  end

  -- turn things off
  hittable = {}
  disableTrigger(&quot;svobl Don't register&quot;)
  svo.signals.after_prompt_processing:block(sk.bl_checkburncounter)
end

function svo.bl_count(who, what)
  bl_list[who] = bl_list[who] or {level = 0, dehydrate = 0}
  svo.lasthit = who

  hittable[who] = what
  svo.signals.after_prompt_processing:unblock(sk.bl_checkburncounter)
  enableTrigger(&quot;svokl Don't register&quot;)
end

svo.signals.after_prompt_processing:connect(sk.bl_checkburncounter)
svo.signals.after_prompt_processing:block(sk.bl_checkburncounter)

function svo.bl_ignore()
  if not next(hittable) then return end
  table.remove(select(2, next(hittable)))
end

function svo.bl_reset(whom, quiet)
  if svo.defc.dragonform then return end

  if whom then whom = string.title(whom) end
  local echof = svo.echof
  if quiet then echof = function() end end


  if whom == 'All' then
    bl_list = {}
    echof(&quot;Reset everyone's burn status.&quot;)
  elseif not whom and svo.lasthit then
    bl_list[svo.lasthit] = {level = 0, dehydrate = 0}
    echof(&quot;Reset %s's burn status.&quot;, svo.lasthit)
  elseif bl_list[whom:lower()] then
    if not svo.lasthit or not bl_list[svo.lasthit] then
      echof(&quot;Not keeping track of anyone yet to reset their burn.&quot;)
    end
  elseif whom then
    if bl_list[whom] then
      bl_list[whom] = nil
      echof(&quot;Reset %s's burn status.&quot;, whom)
    else
      echof(&quot;Weren't keeping track of %s anyway.&quot;, whom)
    end
  else
    echof(&quot;Not keeping track of anyone to reset them anyway.&quot;)
  end
  raiseEvent(&quot;svo burncounter reset&quot;)
end

function svo.bl_show()
  if not next(bl_list) then svo.echof(&quot;burncounter: Not keeping track of anyone yet.&quot;); return end

  setFgColor(unpack(svo.getDefaultColorNums))
  for person, burnt in pairs(bl_list) do
    echo(&quot;---&quot;..person..&quot; &quot;) fg('a_darkgrey')
    echoLink(&quot;(reset)&quot;, 'svo.bl_reset&quot;'..person..'&quot;', &quot;Reset burn status for &quot;..person, true)
    setFgColor(unpack(svo.getDefaultColorNums))
    echo(string.rep(&quot;-&quot;, (92-#person-12))) -- 12 for the 'reset' link
    echo&quot;\n&quot;
    echo(string.format(&quot; burn level: %s (%s), dehydrated: %s&quot;, burn_levels[burnt.level] or 'none', burnt.level, (burnt.dehydrate == 0 and 'no' or 'yes')))
    echo&quot;\n&quot;
  end
  echo(string.rep(&quot;-&quot;, 91))
end

svo.echof(&quot;Loaded svo Magi burncounter.&quot;)
</script>
                <eventHandlerList/>
            </Script>
        </ScriptGroup>
    </ScriptPackage>
    <KeyPackage/>
    <HelpPackage>
        <helpURL></helpURL>
    </HelpPackage>
</MudletPackage>
